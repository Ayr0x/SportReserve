{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reservar {{ cancha.nombre }}</title>
    <link rel="icon" type="image/png" href="{% static 'img/logo-top.png' %}">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        
        /* Botones de hora personalizados */
        .btn-hora {
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            font-weight: 500;
            background-color: white;
            color: #555;
            padding: 15px 0;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
        }
        
        .btn-hora:hover {
            border-color: #2E8B57;
            color: #2E8B57;
        }

        /* ESTADO: SELECCIONADO (Verde) */
        .btn-check:checked + .btn-hora {
            background-color: #2E8B57;
            border-color: #2E8B57;
            color: white;
            box-shadow: 0 4px 6px rgba(46, 139, 87, 0.3);
            font-weight: bold;
        }

        /* ESTADO: OCUPADO (Rojo suave) */
        .estado-ocupado {
            background-color: #ffebee !important;
            border-color: #ffcdd2 !important;
            color: #c62828 !important;
            cursor: not-allowed;
            opacity: 0.9;
        }

        /* ESTADO: PASADO (Gris tachado) */
        .estado-pasado {
            background-color: #e9ecef !important;
            border-color: #dee2e6 !important;
            color: #adb5bd !important;
            text-decoration: line-through;
            cursor: not-allowed;
        }

        /* Pestañas de Navegación AM/PM */
        .nav-pills .nav-link.active {
            background-color: #2E8B57;
        }
        .nav-pills .nav-link {
            color: #2E8B57;
            font-weight: bold;
            border: 1px solid #eee;
            margin: 0 5px;
        }
        
        .card-img-top-custom {
            height: 250px;
            object-fit: cover;
            border-radius: 15px 15px 0 0;
        }
    </style>
</head>
<body>

    <!-- Navbar simplificado -->
    <nav class="navbar navbar-light bg-white shadow-sm mb-4">
        <div class="container">
            <a class="navbar-brand fw-bold text-success" href="{% url 'index' %}">
                <i class="fas fa-arrow-left"></i> Volver al Inicio
            </a>
        </div>
    </nav>

    <div class="container pb-5">
        <div class="row justify-content-center">
            
            <!-- PANEL IZQUIERDO: INFORMACIÓN CANCHA -->
            <div class="col-md-4 mb-4">
                <div class="card border-0 shadow-sm rounded-4 sticky-top" style="top: 100px;">
                    {% if cancha.imagen %}
                        <img src="{{ cancha.imagen.url }}" class="card-img-top-custom w-100">
                    {% else %}
                        <img src="https://via.placeholder.com/600x400?text=Cancha" class="card-img-top-custom w-100">
                    {% endif %}
                    <div class="card-body p-4">
                        <h3 class="fw-bold">{{ cancha.nombre }}</h3>
                        <p class="text-muted small mb-3">{{ cancha.descripcion }}</p>
                        
                        <ul class="list-group list-group-flush small">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <i class="far fa-clock text-primary"></i> Horario
                                <span class="fw-bold">{{ cancha.hora_apertura|time:"H:i" }} - {{ cancha.hora_cierre|time:"H:i" }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <i class="fas fa-layer-group text-primary"></i> Superficie
                                <span class="badge bg-secondary">{{ cancha.get_superficie_display }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <i class="fas fa-tag text-primary"></i> Precio Hora
                                <span class="fs-5 fw-bold text-success">${{ cancha.precio_hora }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- PANEL DERECHO: CALENDARIO Y PAGO -->
            <div class="col-md-8">
                <div class="card border-0 shadow-sm rounded-4 p-4">
                    <form method="POST" action="{% url 'procesar_pago' %}">
                        {% csrf_token %}
                        <input type="hidden" name="cancha_id" value="{{ cancha.id }}">
                        
                        <!-- 1. SELECTOR DE FECHA -->
                        <div class="row align-items-end mb-4 bg-light p-3 rounded-3">
                            <div class="col-md-7">
                                <label class="form-label fw-bold text-muted small">SELECCIONA LA FECHA</label>
                                <input type="date" id="fechaSelector" name="fecha" class="form-control form-control-lg fw-bold border-success" 
                                       required value="{{ fecha_seleccionada }}" min="2024-11-01">
                            </div>
                            <div class="col-md-5 text-md-end mt-2 mt-md-0">
                                <small class="text-muted"><i class="fas fa-info-circle"></i> Cambia la fecha para ver disponibilidad.</small>
                            </div>
                        </div>

                        <!-- 2. ZONA DE HORARIOS -->
                        <label class="form-label fw-bold text-muted small mb-3">HORAS DISPONIBLES</label>
                        
                        {% if not fecha_seleccionada %}
                            <!-- Caso: No ha elegido fecha -->
                            <div class="alert alert-info py-4 text-center border-0 shadow-sm">
                                <h5><i class="far fa-calendar-check"></i> Comencemos</h5>
                                <p class="mb-0">Por favor, selecciona una fecha arriba para cargar los horarios.</p>
                            </div>

                        {% elif es_feriado_cerrado %}
                            <!-- Caso: Es feriado y está cerrado -->
                            <div class="alert alert-danger text-center py-5 border-0 shadow-sm bg-danger text-white bg-opacity-75">
                                <h1 class="mb-3"><i class="fas fa-store-slash"></i></h1>
                                <h4>Recinto Cerrado</h4>
                                <p class="mb-0">{{ mensaje_alerta }}</p>
                            </div>

                        {% else %}
                            
                            <!-- PESTAÑAS AM / PM -->
                            <ul class="nav nav-pills mb-4 nav-fill" id="pills-tab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active py-2" id="pills-am-tab" data-bs-toggle="pill" data-bs-target="#pills-am" type="button">
                                        <i class="fas fa-sun text-warning me-2"></i> Mañana (AM)
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link py-2" id="pills-pm-tab" data-bs-toggle="pill" data-bs-target="#pills-pm" type="button">
                                        <i class="fas fa-moon text-primary me-2"></i> Tarde (PM)
                                    </button>
                                </li>
                            </ul>

                            <div class="tab-content mb-4" id="pills-tabContent">
                                
                                <!-- CONTENIDO MAÑANA (AM) -->
                                <div class="tab-pane fade show active" id="pills-am" role="tabpanel">
                                    <div class="row g-2">
                                        {% for bloque in bloques_manana %}
                                            <div class="col-4 col-sm-3 col-lg-2">
                                                <input type="checkbox" class="btn-check hora-checkbox" 
                                                       name="horas[]" value="{{ bloque.hora }}" id="am-{{ bloque.hora }}" 
                                                       data-precio="{{ cancha.precio_hora }}"
                                                       {% if bloque.estado != 'disponible' %}disabled{% endif %}>
                                                
                                                <!-- Lógica visual de clases según estado -->
                                                <label class="btn btn-hora 
                                                       {% if bloque.estado == 'ocupado' %}estado-ocupado
                                                       {% elif bloque.estado == 'pasado' %}estado-pasado{% endif %}" 
                                                       for="am-{{ bloque.hora }}">
                                                    
                                                    {{ bloque.hora }}
                                                    
                                                    <!-- Texto pequeño de estado -->
                                                    {% if bloque.estado == 'ocupado' %}
                                                        <div class="small fw-bold" style="font-size: 0.65em;">OCUPADO</div>
                                                    {% elif bloque.estado == 'pasado' %}
                                                        <div class="small fw-bold" style="font-size: 0.65em;">CERRADO</div>
                                                    {% endif %}
                                                </label>
                                            </div>
                                        {% empty %}
                                            <p class="text-center text-muted py-3">
                                                <i class="fas fa-coffee"></i> No hay horarios disponibles en la mañana o el recinto abre tarde.
                                            </p>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- CONTENIDO TARDE (PM) -->
                                <div class="tab-pane fade" id="pills-pm" role="tabpanel">
                                    <div class="row g-2">
                                        {% for bloque in bloques_tarde %}
                                            <div class="col-4 col-sm-3 col-lg-2">
                                                <input type="checkbox" class="btn-check hora-checkbox" 
                                                       name="horas[]" value="{{ bloque.hora }}" id="pm-{{ bloque.hora }}" 
                                                       data-precio="{{ cancha.precio_hora }}"
                                                       {% if bloque.estado != 'disponible' %}disabled{% endif %}>
                                                
                                                <label class="btn btn-hora 
                                                       {% if bloque.estado == 'ocupado' %}estado-ocupado
                                                       {% elif bloque.estado == 'pasado' %}estado-pasado{% endif %}" 
                                                       for="pm-{{ bloque.hora }}">
                                                    
                                                    {{ bloque.hora }}

                                                    {% if bloque.estado == 'ocupado' %}
                                                        <div class="small fw-bold" style="font-size: 0.65em;">OCUPADO</div>
                                                    {% elif bloque.estado == 'pasado' %}
                                                        <div class="small fw-bold" style="font-size: 0.65em;">CERRADO</div>
                                                    {% endif %}
                                                </label>
                                            </div>
                                        {% empty %}
                                            <p class="text-center text-muted py-3">
                                                <i class="fas fa-moon"></i> No hay horarios disponibles en la tarde o el recinto ya cerró.
                                            </p>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- BARRA DE PAGO FLOTANTE -->
                        <div class="card bg-white border border-success border-2 shadow-sm sticky-bottom">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="small text-muted fw-bold text-uppercase">Total a Pagar</div>
                                    <div id="total-precio" class="fs-2 fw-bold text-success">$0</div>
                                </div>
                                
                                <button type="submit" class="btn btn-success px-4 py-3 fw-bold shadow" id="btn-pagar" disabled>
                                    Pagar <span id="contador-horas" class="badge bg-white text-success ms-1 rounded-pill">0</span> hrs
                                </button>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT: CALCULADORA Y FECHAS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. Recargar al cambiar fecha
        const fechaInput = document.getElementById('fechaSelector');
        fechaInput.addEventListener('change', function() {
            window.location.href = `?fecha=${this.value}`;
        });

        // 2. Establecer fecha mínima (HOY)
        const hoy = new Date().toISOString().split("T")[0];
        document.getElementById("fechaSelector").setAttribute("min", hoy);

        // 3. Calculadora de Precios
        const checkboxes = document.querySelectorAll('.hora-checkbox');
        const contadorDisplay = document.getElementById('contador-horas');
        const totalDisplay = document.getElementById('total-precio');
        const btnPagar = document.getElementById('btn-pagar');

        checkboxes.forEach(cb => {
            cb.addEventListener('change', actualizarTotal);
        });

        function actualizarTotal() {
            let total = 0;
            let count = 0;
            
            checkboxes.forEach(cb => {
                if (cb.checked) {
                    total += parseInt(cb.dataset.precio);
                    count++;
                }
            });

            // Formatear a pesos chilenos ($ 25.000)
            const totalFmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(total);
            
            contadorDisplay.innerText = count;
            totalDisplay.innerText = totalFmt;
            
            // Habilitar / Deshabilitar botón
            if(count > 0) {
                btnPagar.disabled = false;
                btnPagar.innerHTML = `Pagar <span class="badge bg-white text-success ms-1 rounded-pill">${count}</span> hrs`;
            } else {
                btnPagar.disabled = true;
                btnPagar.innerHTML = `Selecciona Horas`;
            }
        }
    </script>
</body>
</html>